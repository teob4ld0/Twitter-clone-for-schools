<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA Health Check - Twittetec</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f8fa;
        }
        h1 {
            color: #1da1f2;
        }
        .check-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .check-item h3 {
            margin: 0 0 10px 0;
            color: #14171a;
        }
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        .status.pass {
            background: #17bf63;
            color: white;
        }
        .status.fail {
            background: #e0245e;
            color: white;
        }
        .status.warn {
            background: #ffad1f;
            color: white;
        }
        .info {
            color: #657786;
            font-size: 14px;
            margin-top: 8px;
        }
        button {
            background: #1da1f2;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px 5px 10px 0;
        }
        button:hover {
            background: #0d8bd9;
        }
        pre {
            background: #f7f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>üîç PWA Health Check - Twittetec</h1>
    <p>Verifica que tu Progressive Web App est√© configurada correctamente</p>
    
    <button onclick="runAllChecks()">‚ñ∂Ô∏è Ejecutar Todas las Verificaciones</button>
    <button onclick="location.reload()">üîÑ Recargar</button>
    
    <div id="results"></div>

    <script>
        const results = document.getElementById('results');

        function addCheck(title, status, info) {
            const div = document.createElement('div');
            div.className = 'check-item';
            div.innerHTML = `
                <h3>${title} <span class="status ${status}">${status.toUpperCase()}</span></h3>
                <div class="info">${info}</div>
            `;
            results.appendChild(div);
        }

        async function runAllChecks() {
            results.innerHTML = '';
            
            // 1. Service Worker
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.getRegistration();
                    if (registration) {
                        addCheck(
                            '‚úì Service Worker',
                            'pass',
                            `Registrado y activo. Scope: ${registration.scope}<br>Estado: ${registration.active ? 'Active' : 'Pending'}`
                        );
                    } else {
                        addCheck(
                            '‚úó Service Worker',
                            'fail',
                            'No hay Service Worker registrado. Verifica que /sw.js est√© accesible.'
                        );
                    }
                } catch (error) {
                    addCheck('‚úó Service Worker', 'fail', `Error: ${error.message}`);
                }
            } else {
                addCheck('‚úó Service Worker', 'fail', 'Service Workers no soportados en este navegador');
            }

            // 2. Manifest
            const manifestLink = document.querySelector('link[rel="manifest"]');
            if (manifestLink) {
                try {
                    const response = await fetch(manifestLink.href);
                    const manifest = await response.json();
                    addCheck(
                        '‚úì Manifest',
                        'pass',
                        `Encontrado: ${manifestLink.href}<br>Nombre: ${manifest.name}<br>Icons: ${manifest.icons?.length || 0}<br><pre>${JSON.stringify(manifest, null, 2)}</pre>`
                    );
                } catch (error) {
                    addCheck('‚ö† Manifest', 'warn', `Manifest link existe pero error al cargar: ${error.message}`);
                }
            } else {
                addCheck('‚úó Manifest', 'fail', 'No se encontr√≥ link al manifest.json en el HTML');
            }

            // 3. HTTPS
            if (location.protocol === 'https:' || location.hostname === 'localhost') {
                addCheck(
                    '‚úì HTTPS',
                    'pass',
                    `Servido correctamente: ${location.protocol}//${location.host}`
                );
            } else {
                addCheck(
                    '‚úó HTTPS',
                    'fail',
                    'PWAs requieren HTTPS. Actualmente en HTTP. Solo localhost est√° exento.'
                );
            }

            // 4. Icons
            const iconSvg = await checkResource('/icon.svg');
            const icon192 = await checkResource('/icon-192.png');
            const icon512 = await checkResource('/icon-512.png');
            
            const iconsFound = [iconSvg, icon192, icon512].filter(Boolean).length;
            if (iconsFound >= 2) {
                addCheck(
                    '‚úì Iconos',
                    'pass',
                    `${iconsFound}/3 iconos encontrados:<br>` +
                    `icon.svg: ${iconSvg ? '‚úì' : '‚úó'}<br>` +
                    `icon-192.png: ${icon192 ? '‚úì' : '‚úó'}<br>` +
                    `icon-512.png: ${icon512 ? '‚úì' : '‚úó'}`
                );
            } else {
                addCheck(
                    '‚ö† Iconos',
                    'warn',
                    `Solo ${iconsFound}/3 iconos encontrados. PWA instalable requiere al menos 192x192 y 512x512.`
                );
            }

            // 5. Push Notifications
            if ('Notification' in window) {
                addCheck(
                    '‚úì Notifications API',
                    Notification.permission === 'granted' ? 'pass' : 'warn',
                    `API disponible. Permiso: ${Notification.permission}`
                );
            } else {
                addCheck('‚úó Notifications API', 'fail', 'API de notificaciones no disponible');
            }

            // 6. Cache Storage
            if ('caches' in window) {
                try {
                    const cacheNames = await caches.keys();
                    if (cacheNames.length > 0) {
                        let totalSize = 0;
                        for (const name of cacheNames) {
                            const cache = await caches.open(name);
                            const keys = await cache.keys();
                            totalSize += keys.length;
                        }
                        addCheck(
                            '‚úì Cache Storage',
                            'pass',
                            `${cacheNames.length} cache(s) encontrados: ${cacheNames.join(', ')}<br>Total de recursos cacheados: ${totalSize}`
                        );
                    } else {
                        addCheck('‚ö† Cache Storage', 'warn', 'API disponible pero sin cach√©s a√∫n. Normal en primera visita.');
                    }
                } catch (error) {
                    addCheck('‚ö† Cache Storage', 'warn', `Error al leer cach√©s: ${error.message}`);
                }
            } else {
                addCheck('‚úó Cache Storage', 'fail', 'Cache Storage API no disponible');
            }

            // 7. Installability
            let isInstallable = false;
            window.addEventListener('beforeinstallprompt', (e) => {
                isInstallable = true;
            });
            
            // Check if already installed
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches || 
                                window.navigator.standalone === true;
            
            if (isStandalone) {
                addCheck('‚úì Instalaci√≥n', 'pass', 'App ya est√° instalada y ejecut√°ndose en modo standalone');
            } else if (isInstallable) {
                addCheck('‚úì Instalable', 'pass', 'App puede ser instalada. Busca el banner o icono en la barra.');
            } else {
                addCheck(
                    '‚ö† Instalaci√≥n',
                    'warn',
                    'No se detect√≥ evento de instalaci√≥n. Esto es normal si ya est√° instalada o si faltan requisitos.'
                );
            }

            // 8. Device Info
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            addCheck(
                '‚ÑπÔ∏è Device Info',
                'pass',
                `User Agent: ${navigator.userAgent}<br>` +
                `Mobile: ${isMobile ? 'S√≠' : 'No'}<br>` +
                `Viewport: ${window.innerWidth}x${window.innerHeight}<br>` +
                `Online: ${navigator.onLine ? 'S√≠' : 'No'}`
            );

            // 9. Summary
            const checks = results.querySelectorAll('.status');
            const passed = Array.from(checks).filter(s => s.classList.contains('pass')).length;
            const failed = Array.from(checks).filter(s => s.classList.contains('fail')).length;
            const warnings = Array.from(checks).filter(s => s.classList.contains('warn')).length;
            
            addCheck(
                'üìä Resumen',
                failed > 0 ? 'warn' : 'pass',
                `‚úì ${passed} checks pasados | ‚ö† ${warnings} warnings | ‚úó ${failed} fallos`
            );
        }

        async function checkResource(url) {
            try {
                const response = await fetch(url, { method: 'HEAD' });
                return response.ok;
            } catch {
                return false;
            }
        }

        // Auto-run on load
        window.addEventListener('load', () => {
            setTimeout(runAllChecks, 500);
        });
    </script>
</body>
</html>
